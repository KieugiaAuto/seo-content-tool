<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>T·∫°o n·ªôi dung SEO cho Ki·ªÅu Gia Auto</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #f4f4f4;
    }
    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }
    h1 {
      text-align: center;
      color: #333;
    }
    .form-group {
      margin-bottom: 15px;
    }
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 5px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      background-color: #28a745;
      color: #fff;
      border: none;
      padding: 10px 20px;
      border-radius: 4px;
      cursor: pointer;
    }
    button:hover {
      background-color: #218838;
    }
    .button-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    #preview {
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 4px;
      background-color: #f9f9f9;
    }
    @media (max-width: 600px) {
      .button-container {
        flex-direction: column;
      }
      button {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>T·∫°o n·ªôi dung SEO cho Ki·ªÅu Gia Auto</h1>
    <div class="form-group">
      <label for="ten">T√™n ph·ª• t√πng:</label>
      <input type="text" id="ten" placeholder="V√≠ d·ª•: C√†ng A Suzuki Swift 2013-2018">
    </div>
    <div class="form-group">
      <label for="ma">M√£ s·∫£n ph·∫©m:</label>
      <input type="text" id="ma" placeholder="V√≠ d·ª•: CANGA123">
    </div>
    <div class="form-group">
      <label for="thuonghieu">Th∆∞∆°ng hi·ªáu:</label>
      <input type="text" id="thuonghieu" placeholder="V√≠ d·ª•: Suzuki">
    </div>
    <div class="form-group">
      <label for="xuatxu">Xu·∫•t x·ª©:</label>
      <input type="text" id="xuatxu" placeholder="V√≠ d·ª•: Nh·∫≠t B·∫£n">
    </div>
    <div class="form-group">
      <label for="website">Ch·ªçn website:</label>
      <select id="website">
        <option value="phutunggiare">Ph·ª• t√πng gi√° r·∫ª</option>
        <option value="kieugiaauto">Ki·ªÅu Gia Auto</option>
        <option value="banphutung">B√°n ph·ª• t√πng</option>
        <option value="phutungotokieugia">Ph·ª• t√πng √¥ t√¥ Ki·ªÅu Gia</option>
        <option value="shopee">Shopee</option>
      </select>
    </div>
    <div class="button-container">
      <button onclick="taoNoiDung()">T·∫°o n·ªôi dung</button>
      <button id="copyButton" onclick="saoChepNoiDung()" style="display: none;">üìã Sao ch√©p n·ªôi dung</button>
    </div>
    <div id="preview"></div>
  </div>

  <script src="moTaTheoLoai.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
  const supabaseUrl = 'https://iilwrpvussatcwkdbpwz.supabase.co';
  const supabaseKey = 'sb_publishable_SjMakW0cOTbhYrEz666NmA_h0EjQTbQ';
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);
</script>
  <script>
    
    // H√†m lo·∫°i b·ªè d·∫•u ti·∫øng Vi·ªát ƒë·ªÉ x·ª≠ l√Ω t·ª´ kh√≥a
    function removeVietnameseTones(str) {
      return str
        .normalize('NFD')
        .replace(/[\u0300-\u036f]/g, '')
        .replace(/ƒë/g, 'd')
        .replace(/ƒê/g, 'D');
    }

    // ============================
// AUTO REROLL M√î T·∫¢ (ch·ªëng tr√πng gi·ªØa 4 web)
// ============================
const KG_TRACK_SITES = new Set(['kieugiaauto','phutunggiare','banphutung','phutungotokieugia']);

function kgNormalizeText(s) {
  return (s || '')
    .toString()
    .replace(/<[^>]*>/g, ' ')
    .replace(/\s+/g, ' ')
    .trim()
    .toLowerCase();
}

// ===== NEAR DUPLICATE CHECK (Jaccard >= 80%) =====
function kgTokenize(s) {
  const t = removeVietnameseTones(kgNormalizeText(s))
    .replace(/[^a-z0-9\s]/g, ' ')
    .replace(/\s+/g, ' ')
    .trim();

  if (!t) return [];

  return t.split(' ').filter(w => w.length >= 2);
}

function kgJaccardSim(a, b) {
  const A = new Set(kgTokenize(a));
  const B = new Set(kgTokenize(b));

  if (A.size === 0 || B.size === 0) return 0;

  let inter = 0;
  for (const x of A) if (B.has(x)) inter++;

  const uni = A.size + B.size - inter;
  return uni ? (inter / uni) : 0;
}


function kgKeyNormalize(s) {
  return removeVietnameseTones((s || '').toString())
    .toLowerCase()
    .replace(/[^a-z0-9]+/g, '')   // ‚úÖ b·ªè lu√¥n d·∫•u -, space, / ...
    .trim();
}


// ‚úÖ ∆Øu ti√™n MA (SKU) ƒë·ªÉ key lu√¥n gi·ªëng nhau gi·ªØa c√°c web
function kgMakeProductKey(ten, ma) {
  const sku = kgKeyNormalize(ma);
  if (sku) return `sku__${sku}`;

  const name = kgKeyNormalize(ten);
  return `name__${name}`;
}

function kgLoadDescStore() {
  try { return JSON.parse(localStorage.getItem('kg_desc_store') || '{}'); }
  catch (e) { return {}; }
}
function kgSaveDescStore(store) {
  localStorage.setItem('kg_desc_store', JSON.stringify(store));
}

// =========================
// TTL 20 ng√†y + Auto Purge khi ƒë·∫ßy
// =========================
const KG_TTL_DAYS = 20;
const KG_TTL_MS = KG_TTL_DAYS * 24 * 60 * 60 * 1000;

function kgNormalizeStore(store) {
  const now = Date.now();
  let changed = false;

  for (const pkey of Object.keys(store || {})) {
    const sites = store[pkey] || {};
    for (const site of Object.keys(sites)) {
      const item = sites[site];

      if (typeof item === 'string') {
        sites[site] = { desc: item, ts: now };
        changed = true;
        continue;
      }

      if (item && typeof item === 'object' && item.desc && !item.ts) {
        item.ts = now;
        changed = true;
      }
    }
    store[pkey] = sites;
  }

  return { store, changed };
}


function kgListAllEntries(store) {
  const rows = [];
  for (const pkey of Object.keys(store || {})) {
    for (const site of Object.keys((store[pkey] || {}))) {
      const item = store[pkey][site];
      const ts = (item && typeof item === 'object' && item.ts) ? item.ts : 0;
      rows.push({ pkey, site, ts });
    }
  }
  rows.sort((a, b) => (a.ts || 0) - (b.ts || 0));
  return rows;
}

function kgDeleteEntry(store, pkey, site) {
  if (!store[pkey]) return;
  delete store[pkey][site];
  if (!Object.keys(store[pkey]).length) delete store[pkey];
}

function kgPurgeExpiredOnly(store) {
  const now = Date.now();

  for (const pkey of Object.keys(store || {})) {
    const sites = store[pkey] || {};

    for (const site of Object.keys(sites)) {
      const item = sites[site];
      const ts = (item && typeof item === 'object' && item.ts) ? item.ts : 0;

      if (!ts || (now - ts) >= KG_TTL_MS) {
        delete sites[site];
      }
    }

    if (!Object.keys(sites).length) {
      delete store[pkey];
    }
  }

  return store;
}

function kgSaveDescStoreSafe(store) {
  // normalize tr∆∞·ªõc (kh√¥ng xo√°)
  const norm = kgNormalizeStore(store);
  store = norm.store;

  const trySave = () => localStorage.setItem('kg_desc_store', JSON.stringify(store));

  try {
    trySave();
    return true;
  } catch (e) {
    // ‚úÖ ch·ªâ khi localStorage ƒë·∫ßy m·ªõi purge nh·ªØng c√°i > 20 ng√†y
    store = kgPurgeExpiredOnly(store);

    try {
      trySave();
      return true;
    } catch (e2) {
      // v·∫´n ƒë·∫ßy m√† kh√¥ng c√≥ g√¨ qu√° 20 ng√†y ƒë·ªÉ xo√°
      return false;
    }
  }
}

// L∆ØU m√¥ t·∫£ ƒë√£ d√πng cho 1 s·∫£n ph·∫©m + 1 web
function kgCommitDesc(productKey, website, descHtml) {
  let store = kgLoadDescStore();

  // normalize format c≈© n·∫øu c√≥
  const norm = kgNormalizeStore(store);
  store = norm.store;

  if (!store[productKey]) store[productKey] = {};

  store[productKey][website] = {
    desc: kgNormalizeText(descHtml),
    ts: Date.now()
  };

  // ‚úÖ D·ªåN ngay c√°c entry >= 20 ng√†y
  store = kgPurgeExpiredOnly(store);

  const ok = kgSaveDescStoreSafe(store);
  if (!ok) console.warn('kg_desc_store ƒë·∫ßy, kh√¥ng th·ªÉ l∆∞u.');
}

// =========================
// GHI M√î T·∫¢ L√äN SUPABASE
// =========================
async function kgUpsertDescToSupabase(productKey, website, descHtml) {
  const descNorm = kgNormalizeText(descHtml);

  const { error } = await supabase
    .from('desc_store')
    .upsert(
      [{ product_key: productKey, website, desc_norm: descNorm }],
      { onConflict: 'product_key,website' }
    );

  if (error) console.error('‚ùå L·ªói upsert Supabase:', error);
  else console.log('‚úÖ Upsert m√¥ t·∫£ l√™n Supabase');
}

// CHECK tr√πng tuy·ªát ƒë·ªëi (b∆∞·ªõc #1 ch·ªâ c·∫ßn th·∫ø n√†y)
async function kgIsDuplicateDesc(productKey, website, descHtml, threshold = 0.8) {
  const descNorm = kgNormalizeText(descHtml);

  const { data, error } = await supabase
    .from('desc_store')
    .select('website, desc_norm, created_at')
    .eq('product_key', productKey)
    .neq('website', website)
    .gte('created_at', new Date(Date.now() - 20*24*60*60*1000).toISOString());

  if (error) {
    console.error(error);
    return { duplicate: false, similarity: 0 };
  }

  let bestSim = 0;
  let bestSite = '';

  for (const row of data || []) {
    if (row.desc_norm === descNorm) {
      return { duplicate: true, conflictSite: row.website, similarity: 1, exact: true };
    }

    const sim = kgJaccardSim(row.desc_norm, descNorm);
    if (sim > bestSim) { bestSim = sim; bestSite = row.website; }

    if (sim >= threshold) {
      return { duplicate: true, conflictSite: row.website, similarity: sim, exact: false };
    }
  }

  return { duplicate: false, similarity: bestSim, conflictSite: bestSite };
}

   // H√†m t·∫°o m√¥ t·∫£ SEO t·ª± ƒë·ªông d·ª±a tr√™n t√™n ph·ª• t√πng
   async function sinhMoTaTuDong(ten) {
      const regex = /(.*?)(ac|acura|aeolus|alfa_romeo|alpine|aston_martin|audi|bac|bahman|baic|bentley|bmw|bollinger|brilliance|bugatti|buick|byd|cadillac|callaway|carver|chery|chevrolet|chrysler|citroen|cupra|daihatsu|dodge|ds|ferrari|fiat|fisker|ford|geely|genesis|gmc|haval|hino|honda|hummer|hyundai|infiniti|isuzu|jaguar|jeep|kia|lamborghini|land_rover|lexus|lincoln|lotus|lucid|maserati|maybach|mazda|mclaren|mercedes_benz|mg|mini|mitsubishi|nissan|opel|pagani|peugeot|porsche|ram|renault|rivian|rolls_royce|saic|seat|skoda|smart|ssangyong|subaru|suzuki|tesla|toyota|vinfast|volkswagen|volvo|daewoo|mercedes)[\s-]+([a-zA-Z0-9\s.]+)(?:\s+(\d{4})(?:\D+(\d{4}))?)?$/i;
      const match = ten.match(regex);
if (!match) {
  return `<p>Ph·ª• t√πng √¥ t√¥ ch·∫•t l∆∞·ª£ng cao, t∆∞∆°ng th√≠ch v·ªõi nhi·ªÅu d√≤ng xe, ƒë·∫£m b·∫£o hi·ªáu su·∫•t v√† ƒë·ªô b·ªÅn t·ªëi ∆∞u.</p>`;
}

      const tenPhuTung = match[1].trim();
      const hang = match[2].replace('_', '-').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
      const dong = match[3].trim();
      const nam1 = match[4] || '';
      const nam2 = match[5] || '';
      const dateText = nam1 ? (nam2 ? ` t·ª´ ${nam1} ƒë·∫øn ${nam2}` : ` ƒë·ªùi ${nam1}`) : '';
      const website = document.getElementById('website').value;

      let gioiThieu = '';

      // T√°ch tenPhuTung th√†nh c√°c ph·∫ßn v√† t·∫°o danh s√°ch bi·∫øn th·ªÉ
      const tenPhuTungParts = tenPhuTung.split(' ');
      const tenPhuTungVariants = [];
      for (let i = tenPhuTungParts.length; i >= 2; i--) { // B·∫Øt ƒë·∫ßu t·ª´ ƒë·ªô d√†i l·ªõn nh·∫•t, t·ªëi thi·ªÉu 2 t·ª´
        tenPhuTungVariants.push(tenPhuTungParts.slice(0, i).join(' ').trim());
      }

      // T·∫°o danh s√°ch t·ª´ kh√≥a theo th·ª© t·ª± ∆∞u ti√™n
      const keywords = [];
      // 1. To√†n b·ªô t√™n ph·ª• t√πng
      const fullKey = `${tenPhuTung} ${hang} ${dong}${nam1 ? ` ${nam1}` : ''}${nam2 ? ` ${nam2}` : ''}`.trim();
      keywords.push(fullKey);
      // 2. Ph·∫ßn ph·ª• t√πng + h√£ng + d√≤ng + nƒÉm ƒë·∫ßu (n·∫øu c√≥)
      if (nam1) {
        keywords.push(`${tenPhuTung} ${hang} ${dong} ${nam1}`.trim());
      }
      // 3. Ph·∫ßn ph·ª• t√πng + h√£ng + d√≤ng
      keywords.push(`${tenPhuTung} ${hang} ${dong}`.trim());
      // 4. Ph·∫ßn ph·ª• t√πng + h√£ng
      keywords.push(`${tenPhuTung} ${hang}`.trim());
      // 5. Ch·ªâ ph·∫ßn ph·ª• t√πng
      keywords.push(tenPhuTung);
      // 6. C√°c bi·∫øn th·ªÉ c·ªßa tenPhuTung (b·ªè d·∫ßn t·ª´ cu·ªëi)
      keywords.push(...tenPhuTungVariants);

      // Chu·∫©n h√≥a v√† so kh·ªõp t·ª´ng t·ª´ kh√≥a
      try {
        const tuKhoaList = Object.keys(moTaTheoLoai).sort((a, b) => b.length - a.length);
        for (const keyword of keywords) {
          const keywordNoTones = removeVietnameseTones(keyword).toLowerCase().replace(/\s+/g, ' ').trim();
          for (const tuKhoa of tuKhoaList) {
            const tuKhoaNoTones = removeVietnameseTones(tuKhoa).toLowerCase().replace(/\s+/g, ' ').trim();
            if (keywordNoTones === tuKhoaNoTones) {
              const dsMoTa = moTaTheoLoai[tuKhoa];
              gioiThieu = dsMoTa[Math.floor(Math.random() * dsMoTa.length)];
              break;
            }
          }
          if (gioiThieu) break; // Tho√°t v√≤ng l·∫∑p n·∫øu ƒë√£ t√¨m th·∫•y m√¥ t·∫£
        }
      } catch (err) {
        console.error('L·ªói khi truy c·∫≠p moTaTheoLoai:', err);
      }

            // N·∫øu v·∫´n kh√¥ng c√≥ m√¥ t·∫£ t·ª´ moTaTheoLoai, d√πng m√¥ t·∫£ m·∫∑c ƒë·ªãnh
            if (!gioiThieu) {
        gioiThieu = 'Ph·ª• t√πng √¥ t√¥ ch·∫•t l∆∞·ª£ng cao, t∆∞∆°ng th√≠ch v·ªõi nhi·ªÅu d√≤ng xe, ƒë·∫£m b·∫£o hi·ªáu su·∫•t v√† ƒë·ªô b·ªÅn t·ªëi ∆∞u.';
      }

      // ===== AUTO REROLL CH·ªêNG TR√ôNG =====
      const maInput = (document.getElementById('ma')?.value || '').trim();
      const productKey = kgMakeProductKey(ten, maInput);

      const MAX_REROLL = 8;
      let lastMoTa = '';

      for (let attempt = 1; attempt <= MAX_REROLL; attempt++) {

        const moTaMau = {
          kieugiaauto: [
            `${gioiThieu} S·∫£n ph·∫©m ph√π h·ª£p v·ªõi ${hang} ${dong}${dateText}, d·ªÖ l·∫Øp ƒë·∫∑t, ƒë∆∞·ª£c b·∫£o h√†nh ƒë·∫ßy ƒë·ªß.`,
            `${gioiThieu} ƒê∆∞·ª£c thi·∫øt k·∫ø d√†nh ri√™ng cho ${hang} ${dong}${dateText}, ƒë·∫£m b·∫£o ch√≠nh h√£ng v·ªõi gi√° c·∫°nh tranh.`
          ],
          phutungotokieugia: [
            `${gioiThieu} T∆∞∆°ng th√≠ch v·ªõi ${hang} ${dong}${dateText}, ƒë∆∞·ª£c nhi·ªÅu gara tin d√πng.`,
            `${gioiThieu} H·ªó tr·ª£ k·ªπ thu·∫≠t t·∫≠n t√¢m, ph√π h·ª£p ho√†n h·∫£o cho ${hang} ${dong}${dateText}.`
          ],
          banphutung: [
            `${gioiThieu} Ph√π h·ª£p v·ªõi ${hang} ${dong}${dateText}, lu√¥n c√≥ s·∫µn v√† giao h√†ng to√†n qu·ªëc.`,
            `${gioiThieu} G√≥p ph·∫ßn b·∫£o v·ªá v√† n√¢ng cao hi·ªáu su·∫•t cho ${hang} ${dong}${dateText}.`
          ],
          phutunggiare: [
            `${gioiThieu} T∆∞∆°ng th√≠ch v·ªõi ${hang} ${dong}${dateText}, gi√° ti·∫øt ki·ªám, b·∫£o h√†nh ƒë·∫ßy ƒë·ªß.`,
            `${gioiThieu} L·ª±a ch·ªçn ch√≠nh h√£ng, ti·∫øt ki·ªám chi ph√≠ cho ${hang} ${dong}${dateText}.`
          ],
          shopee: [
            `${gioiThieu} Ph√π h·ª£p v·ªõi ${hang} ${dong}${dateText}, gi√° ∆∞u ƒë√£i tr√™n Shopee.`,
            `${gioiThieu} S·∫£n ph·∫©m ch·∫•t l∆∞·ª£ng cao cho ${hang} ${dong}${dateText}, giao h√†ng nhanh ch√≥ng.`
          ]
        };

        const mau = moTaMau[website];
        if (!mau || !gioiThieu) return '';

        let moTa = `<p>${mau[Math.floor(Math.random() * mau.length)]}</p>`;

        if (website === 'kieugiaauto' || website === 'phutungotokieugia') {
          const linkTrangChu = website === 'kieugiaauto' ? 'https://kieugiaauto.vn' : 'https://phutungotokieugia.vn';
          const regex = new RegExp(`\\b${hang}\\b(?![^<]*>)`, 'i');
          moTa = moTa.replace(regex, `<a href="${linkTrangChu}/${hang.toLowerCase().replace(' ', '-')}" target="_blank">${hang}</a>`);
        }

        lastMoTa = moTa;

        // Ch·ªâ check tr√πng cho 4 web ch√≠nh (shopee kh√¥ng t√≠nh)
        if (KG_TRACK_SITES.has(website)) {
          const dup = await kgIsDuplicateDesc(productKey, website, moTa);
          if (dup.duplicate) {
            // tr√πng -> reroll ti·∫øp
            continue;
          }
        }

        // OK -> tr·∫£ v·ªÅ
        return moTa;
      }

      // N·∫øu reroll v·∫´n tr√πng (xui), tr·∫£ v·ªÅ c√°i cu·ªëi c√πng
      return lastMoTa;
    }

    // H√†m t·∫°o danh s√°ch xe ph√π h·ª£p cho website Shopee
    function sinhDanhSachXe(ten, thuonghieu, isShopee = false) {
      if (!isShopee) {
        return '';
      }

      if (!ten || !thuonghieu) {
        return `<h3>Ph√π h·ª£p v·ªõi c√°c d√≤ng xe:</h3><p>T∆∞∆°ng th√≠ch v·ªõi c√°c d√≤ng xe thu·ªôc th∆∞∆°ng hi·ªáu ${thuonghieu}</p>`;
      }
      ten = ten.toLowerCase();

      const hangXeMap = {
        ac: ["Ace", "Cobra"],
        acura: ["ILX", "MDX", "NSX", "RDX", "TLX"],
        aeolus: ["A30", "A60", "AX7"],
        alfa_romeo: ["Giulia", "Stelvio", "Tonale"],
        alpine: ["A110"],
        aston_martin: ["DB11", "DBS", "Vantage", "Valhalla"],
        audi: ["A3", "A4", "A6", "Q3", "Q5", "Q7", "e-tron"],
        bac: ["Mono"],
        bahman: ["Faw", "Capra"],
        baic: ["X55", "BJ40", "Senova", "M50"],
        bentley: ["Bentayga", "Continental GT", "Flying Spur"],
        bmw: ["3 Series", "5 Series", "7 Series", "X1", "X3", "X5", "i4", "iX"],
        bollinger: ["B1", "B2"],
        brilliance: ["V5", "H530"],
        bugatti: ["Chiron", "Divo"],
        buick: ["Enclave", "Encore", "Envision"],
        byd: ["F0", "F3", "Dolphin", "Atto 3", "Seal", "Han"],
        cadillac: ["Escalade", "CTS", "XT5", "CT5", "Lyriq"],
        callaway: ["Corvette C7", "Camaro"],
        carver: ["One"],
        chery: ["QQ", "Arrizo 3", "Arrizo 5", "Arrizo 6", "Tiggo 2", "Tiggo 3", "Tiggo 4", "Tiggo 5", "Tiggo 7", "Tiggo 8", "Omoda 5"],
        chevrolet: ["Spark", "Aveo", "Cruze", "Lacetti", "Optra", "Captiva", "Orlando", "Colorado", "Trailblazer", "Camaro", "Corvette", "Equinox", "Traverse", "Silverado", "Tahoe", "Suburban"],
        chrysler: ["300", "Pacifica", "Voyager"],
        citroen: ["C3", "C4", "C5 Aircross", "Berlingo"],
        cupra: ["Formentor", "Leon", "Born"],
        daihatsu: ["Terios", "Mira"],
        dodge: ["Challenger", "Charger", "Durango", "Ram"],
        ds: ["DS3", "DS4", "DS7 Crossback"],
        ferrari: ["488", "812 Superfast", "Portofino", "Roma", "SF90"],
        fiat: ["500", "Panda", "Tipo"],
        fisker: ["Ocean"],
        ford: ["Bronco", "Escape", "Explorer", "F-150", "Mustang", "Ranger"],
        geely: ["Coolray", "Emgrand", "Azkarra", "Tugella"],
        genesis: ["G70", "G80", "GV70", "GV80"],
        gmc: ["Acadia", "Sierra", "Yukon", "Terrain"],
        haval: ["H6", "H9", "Jolion"],
        hino: ["300", "500", "700", "Dutro", "XZU", "FG", "FL", "FM", "GH", "SH"],
        honda: ["Brio", "City", "Civic", "Accord", "CR-V", "HR-V", "BR-V", "Pilot", "Odyssey", "Jazz"],
        hummer: ["H2", "H3", "EV"],
        hyundai: ["Grand i10", "Accent", "Elantra", "Sonata", "Azera", "i20", "i30", "Creta", "Kona", "Tucson", "Santa Fe", "Palisade", "Stargazer", "Custin", "Staria", "Solati", "County", "Mighty", "Porter H150", "Universe", "Ioniq 5", "Ioniq 6", "Kona Electric"],
        infiniti: ["Q30", "Q50", "Q60", "QX30", "QX50", "QX55", "QX60", "QX70", "QX80"],
        isuzu: ["D-Max", "MU-X", "N-Series", "F-Series", "Q-Series", "EXZ", "FRR", "FVR", "Giga"],
        jaguar: ["XE", "XF", "XJ", "F-Type", "E-Pace", "F-Pace", "I-Pace"],
        jeep: ["Cherokee", "Compass", "Grand Cherokee", "Wrangler"],
        kia: ["Morning", "Soluto", "Rio", "Cerato", "K3", "K5", "Optima", "Carens", "Rondo", "Seltos", "Sportage", "Sorento", "Carnival", "Sedona", "Soul", "Spectra"],
        lamborghini: ["Aventador", "Huracan", "Urus"],
        land_rover: ["Defender", "Discovery", "Discovery Sport", "Range Rover", "Range Rover Sport", "Range Rover Velar", "Range Rover Evoque"],
        lexus: ["ES", "IS", "GS", "LS", "NX", "RX", "GX", "LX", "UX", "RC", "LC"],
        lincoln: ["Aviator", "Corsair", "Navigator"],
        lotus: ["Emira", "Evora", "Exige"],
        lucid: ["Air"],
        maserati: ["Ghibli", "Levante", "Quattroporte"],
        maybach: ["GLS 600", "S-Class"],
        mazda: ["2", "3", "6", "CX-3", "CX-30", "CX-5", "CX-8", "CX-9", "MX-5", "BT-50"],
        mclaren: ["570S", "720S", "Artura"],
        mercedes_benz: ["A-Class", "B-Class", "C-Class", "E-Class", "S-Class", "CLA", "CLS", "GLA", "GLB", "GLC", "GLE", "GLS", "G-Class", "V-Class", "Maybach"],
        mg: ["ZS", "HS", "MG5", "MG4 EV", "5"],
        mini: ["Cooper", "Countryman", "Clubman"],
        mitsubishi: ["Attrage", "Mirage", "Lancer", "Xpander", "Xpander Cross", "Outlander", "Outlander Sport", "Pajero", "Pajero Sport", "Triton", "Zinger"],
        nissan: ["Almera", "Sunny", "Teana", "Navara", "Terra", "X-Trail", "Juke", "Murano", "Patrol", "Livina"],
        opel: ["Astra", "Corsa", "Mokka"],
        pagani: ["Huayra", "Utopia"],
        peugeot: ["2008", "3008", "5008", "408"],
        porsche: ["911", "Cayenne", "Macan", "Panamera", "Taycan"],
        ram: ["1500", "2500", "3500"],
        renault: ["Captur", "Duster", "Megane", "Talisman"],
        rivian: ["R1S", "R1T"],
        rolls_royce: ["Cullinan", "Ghost", "Phantom"],
        saic: ["Maxus", "Roewe"],
        seat: ["Arona", "Ibiza", "Leon"],
        skoda: ["Kodiaq", "Octavia", "Superb"],
        smart: ["Fortwo", "Forfour"],
        ssangyong: ["Korando", "Rexton", "Tivoli"],
        subaru: ["Ascent", "Forester", "Outback", "WRX"],
        suzuki: ["Ciaz", "Swift", "Ertiga", "XL7", "Vitara", "Carry", "Super Carry Truck", "APV", "Jimny", "500kg", "7ch·ªó"],
        tesla: ["Model 3", "Model S", "Model X", "Model Y"],
        toyota: ["Vios", "Yaris", "Wigo", "Corolla", "Corolla Altis", "Corolla Cross", "Camry", "Avanza", "Veloz", "Innova", "Innova Cross", "Rush", "Fortuner", "Hilux", "Land Cruiser", "Raize", "RAV4", "Zace"],
        vinfast: ["Fadil", "Lux A2.0", "Lux SA2.0", "VF e34", "VF8", "VF9"],
        volkswagen: ["Golf", "Passat", "Polo", "Tiguan", "Touareg"],
        volvo: ["S60", "S90", "XC40", "XC60", "XC90"],
        daewoo: ["Matiz", "Lacetti", "Gentra", "Nubira", "Lanos", "Magnus", "Tosca"]
      };

      const regexWithYears = /(ac|acura|aeolus|alfa_romeo|alpine|aston_martin|audi|bac|bahman|baic|bentley|bmw|bollinger|brilliance|bugatti|buick|byd|cadillac|callaway|carver|chery|chevrolet|chrysler|citroen|cupra|daihatsu|dodge|ds|ferrari|fiat|fisker|ford|geely|genesis|gmc|haval|hino|honda|hummer|hyundai|infiniti|isuzu|jaguar|jeep|kia|lamborghini|land_rover|lexus|lincoln|lotus|lucid|maserati|maybach|mazda|mclaren|mercedes_benz|mg|mini|mitsubishi|nissan|opel|pagani|peugeot|porsche|ram|renault|rivian|rolls_royce|saic|seat|skoda|smart|ssangyong|subaru|suzuki|tesla|toyota|vinfast|volkswagen|volvo|daewoo)(?:[\s-]+([a-zA-Z0-9\s]+?))?(?:[\s-]*(\d{4})(?:[\s-]*(\d{4}))?)?$/i;
      const match = ten.match(regexWithYears);
      if (match) {
        const hang = match[1].replace('_', '-').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
        const dong = match[2] ? match[2].trim().split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ') : '';
        const nam1 = match[3] || '';
        const nam2 = match[4] || '';

        if (nam1 && nam2) {
          const list = [];
          for (let y = parseInt(nam1); y <= parseInt(nam2); y++) {
            list.push(`${hang} ${dong} ${y}`);
          }
          return `<h3>Ph√π h·ª£p v·ªõi c√°c d√≤ng xe:</h3><p>${list.join(', ')}</p>`;
        } else if (nam1) {
          return `<h3>Ph√π h·ª£p v·ªõi c√°c d√≤ng xe:</h3><p>${hang} ${dong} ${nam1}</p>`;
        } else {
          return `<h3>Ph√π h·ª£p v·ªõi c√°c d√≤ng xe:</h3><p>${dong ? `${hang} ${dong}` : hang}</p>`;
        }
      }

      const hangOnly = Object.keys(hangXeMap).find(h => ten.includes(h));
      if (hangOnly) {
        const dongXeList = hangXeMap[hangOnly].slice().sort((a, b) => b.length - a.length);
        const dongXe = dongXeList.find(dong => {
          const pattern = dong.toLowerCase().replace(/\s+/g, '\\s+');
          const regex = new RegExp(pattern, 'i');
          return regex.test(ten);
        });

        const hangUc = hangOnly.replace('_', '-').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');

        if (dongXe) {
          const matchedDong = ten.match(new RegExp(dongXe.toLowerCase().replace(/\s+/g, '\\s*'), 'i'));
          const finalDong = matchedDong
            ? matchedDong[0].split(' ').map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase()).join(' ')
            : dongXe;
          return `<h3>Ph√π h·ª£p v·ªõi c√°c d√≤ng xe:</h3><p>${hangUc} ${finalDong}</p>`;
        }

        return `<h3>Ph√π h·ª£p v·ªõi c√°c d√≤ng xe:</h3><p>${hangUc}</p>`;
      }

      return `<h3>Ph√π h·ª£p v·ªõi c√°c d√≤ng xe:</h3><p>T∆∞∆°ng th√≠ch v·ªõi c√°c d√≤ng xe thu·ªôc th∆∞∆°ng hi·ªáu ${thuonghieu}</p>`;
    }
    async function kgGuardCopy (copyButton, opts = {}) {
  const { silent = false, threshold = 0.65 } = opts;

  const website = copyButton.dataset.website || document.getElementById('website').value;

  const ten = (document.getElementById('ten')?.value || '').trim();
  const ma  = (document.getElementById('ma')?.value || '').trim();
  const pkey = copyButton.dataset.productKey || kgMakeProductKey(ten, ma);

  const descRaw = copyButton.dataset.descHtml || '';
  if (!pkey || !descRaw) {
    copyButton.style.display = 'block';
    return { guarded: false };
  }

  if (!KG_TRACK_SITES.has(website)) {
    copyButton.style.display = 'block';
    return { guarded: false };
  }

  const dup = await kgIsDuplicateDesc (pkey, website, descRaw, threshold);

  if (dup.duplicate) {
    copyButton.style.display = 'none';
    if (!silent) {
      alert(`‚ùå M√¥ t·∫£ tr√πng/g·∫ßn tr√πng (${Math.round(dup.similarity * 100)}%) v·ªõi web "${dup.conflictSite}".\nKh√¥ng cho copy. B·∫•m "T·∫°o n·ªôi dung" l·∫°i ƒë·ªÉ ra m√¥ t·∫£ kh√°c.`);
    }
    return { guarded: true, dup };
  }

  copyButton.style.display = 'block';
  return { guarded: false };
}

async function taoNoiDung() {
  const ten = document.getElementById('ten').value.trim();
  const ma = document.getElementById('ma').value.trim();
  const thuonghieu = document.getElementById('thuonghieu').value.trim();
  const xuatxu = document.getElementById('xuatxu').value.trim();
  const website = document.getElementById('website').value;

  if (!ten || !ma || !thuonghieu || !xuatxu) {
    alert("Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th√¥ng tin!");
    return;
  }

  // Parse nƒÉm linh ho·∫°t t·ª´ cu·ªëi chu·ªói (b·∫Øt 2015-2017 ho·∫∑c 2015)
  const yearRegex = /(\d{4})(?:\D+(\d{4}))?$/i;
  const yearMatch = ten.match(yearRegex);

  let tenPhuTung = ten.trim();
  let dateText = ''; // " 2015‚Äì2017" ho·∫∑c " 2015"
  let nam1 = '';
  let nam2 = '';

  if (yearMatch) {
    nam1 = yearMatch[1];
    nam2 = yearMatch[2] || '';
    dateText = nam2 ? ` ${nam1}‚Äì${nam2}` : ` ${nam1}`;
    // C·∫Øt b·ªè ph·∫ßn nƒÉm kh·ªèi tenPhuTung ƒë·ªÉ t√™n s·∫°ch
    tenPhuTung = ten.replace(yearRegex, '').trim().replace(/\s+$/, '');
  }

  // Parse h√£ng xe v√† d√≤ng xe (regex c≈©, nh∆∞ng gi·ªù optional)
  const regex = /(.*?)(ac|acura|aeolus|alfa_romeo|alpine|aston_martin|audi|bac|bahman|baic|bentley|bmw|bollinger|brilliance|bugatti|buick|byd|cadillac|callaway|carver|chery|chevrolet|chrysler|citroen|cupra|daihatsu|dodge|ds|ferrari|fiat|fisker|ford|geely|genesis|gmc|haval|hino|honda|hummer|hyundai|infiniti|isuzu|jaguar|jeep|kia|lamborghini|land_rover|lexus|lincoln|lotus|lucid|maserati|maybach|mazda|mclaren|mercedes_benz|mg|mini|mitsubishi|nissan|opel|pagani|peugeot|porsche|ram|renault|rivian|rolls_royce|saic|seat|skoda|smart|ssangyong|subaru|suzuki|tesla|toyota|vinfast|volkswagen|volvo|daewoo|mercedes)[\s-]+([a-zA-Z0-9\s.]+)/i;
  const match = tenPhuTung.match(regex);

  let hang = thuonghieu || ''; // ∆Øu ti√™n input th∆∞∆°ng hi·ªáu
  let dong = '';

  if (match) {
    hang = match[2].replace('_', '-').split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    dong = match[3].trim();
  } else {
    // N·∫øu kh√¥ng match h√£ng, d√πng input th∆∞∆°ng hi·ªáu
    hang = thuonghieu;
    dong = tenPhuTung.replace(hang, '').trim(); // ƒêo√°n dong t·ª´ t√™n
  }

  // Variation H1 theo y√™u c·∫ßu cu·ªëi c√πng c·ªßa m√†y
  let h1Text = ten; // Default n·∫øu kh√¥ng parse ƒë∆∞·ª£c
  if (website === 'kieugiaauto') {
    h1Text = tenPhuTung.trim(); // B·ªè nƒÉm cho web ch√≠nh
  } else if (website === 'phutunggiare') {
    h1Text = `${tenPhuTung} m√£ ${ma}`.trim(); // Ph·ª• 1: th√™m m√£ t·ª´ input "ma"
  } else if (website === 'banphutung') {
    h1Text = `${tenPhuTung} gi√° t·ªët`.trim(); // Ph·ª• 2: "gi√° t·ªët"
  } else if (website === 'phutungotokieugia') {
    h1Text = `${tenPhuTung}${dateText}`.trim(); // Ph·ª• 3: gi·ªØ nƒÉm
  } else if (website === 'shopee') {
    h1Text = ten; // Gi·ªØ nguy√™n cho Shopee
  }

  const moTaTuDong = await sinhMoTaTuDong(ten);
 // ===== STEP #2: nh·ªõ m√¥ t·∫£ auto ƒë·ªÉ ch·∫∑n tr√πng khi COPY =====
window.__kg_last_auto_desc = {
  productKey: kgMakeProductKey(ten, ma),
  website,
  descHtml: moTaTuDong
};
  const danhSachXe = sinhDanhSachXe(ten, thuonghieu, website === 'shopee');

  const hangXeList = [
    'Toyota', 'Kia', 'Mazda', 'Ford', 'Honda', 'Hyundai', 'Mitsubishi', 'Nissan', 'Suzuki', 'Chevrolet',
    'Isuzu', 'Daewoo', 'Lexus', 'BMW', 'Mercedes-Benz', 'Audi', 'VinFast', 'Hino', 'Thaco', 'Fiat',
    'Jac', 'Kenbo', 'Veam', 'Dongben', 'SYM', 'Haima', 'Chery', 'Renault', 'Daihatsu', 'Bentley',
    'Range Rover', 'Vinasuki'
  ];

  let hangXeLinks = {};
  switch (website) {
    case 'banphutung':
      hangXeLinks = Object.fromEntries(hangXeList.map(hang => [hang, `https://banphutungoto.vn/${hang.toLowerCase().replace(' ', '-')}`]));
      break;
    case 'phutunggiare':
      hangXeLinks = Object.fromEntries(hangXeList.map(hang => [hang, `https://phutunggiare.vn/phu-tung-${hang.toLowerCase().replace(' ', '-')}`]));
      break;
    case 'phutungotokieugia':
      hangXeLinks = Object.fromEntries(hangXeList.map(hang => [hang, `https://phutungotokieugia.vn/${hang.toLowerCase().replace(' ', '-')}`]));
      break;
    case 'kieugiaauto':
      hangXeLinks = Object.fromEntries(hangXeList.map(hang => [hang, `https://kieugiaauto.vn/${hang.toLowerCase().replace(' ', '-')}`]));
      break;
    default:
      hangXeLinks = {};
  }

  const brandsToLink = [
    'Audi', 'Nissan', 'Kia', 'Daewoo', 'Mazda', 'Ford', 'Toyota', 'Lexus', 'Isuzu', 'Chevrolet',
    'Hyundai', 'Honda', 'Mitsubishi', 'Suzuki', 'Renault', 'Daihatsu', 'Chery', 'BMW', 'Vinasuki',
    'Mercedes-Benz', 'Thaco', 'Fiat', 'Range Rover', 'Bentley'
  ];

      let content = '';
      let copyContent = '';
/* =========================
 * WEB CH√çNH ‚Äì kieugiaauto
 * ========================= */
 if (website === 'kieugiaauto') {
  content = `<h2><strong>${h1Text}</strong></h2>
<p><strong>M√£ s·∫£n ph·∫©m:</strong> ${ma}</p>
<p><strong>Th∆∞∆°ng hi·ªáu:</strong> ${thuonghieu}</p>
<p><strong>Xu·∫•t x·ª©:</strong> ${xuatxu}</p>
${moTaTuDong}

<p>
<strong>${h1Text}</strong> l√† ph·ª• t√πng ƒë∆∞·ª£c s·ª≠ d·ª•ng trong qu√° tr√¨nh
s·ª≠a ch·ªØa v√† thay th·∫ø, gi√∫p ƒë·∫£m b·∫£o kh·∫£ nƒÉng v·∫≠n h√†nh ·ªïn ƒë·ªãnh
v√† ph√π h·ª£p v·ªõi c·∫•u t·∫°o nguy√™n b·∫£n c·ªßa xe.
</p>

<h3>Gi√° tr·ªã s·ª≠ d·ª•ng khi thay th·∫ø ph·ª• t√πng ƒë√∫ng ch·ªßng lo·∫°i</h3>
<p>
Vi·ªác l·ª±a ch·ªçn ph·ª• t√πng ph√π h·ª£p ƒë·ªùi xe v√† ƒë√∫ng ch·ªßng lo·∫°i
gi√∫p ƒë·∫£m b·∫£o kh·∫£ nƒÉng v·∫≠n h√†nh ·ªïn ƒë·ªãnh,
h·∫°n ch·∫ø ph√°t sinh h∆∞ h·ªèng v√† k√©o d√†i tu·ªïi th·ªç c√°c b·ªô ph·∫≠n li√™n quan.
</p>

<h3>Mua ph·ª• t√πng √¥ t√¥ ch√≠nh h√£ng t·∫°i Ki·ªÅu Gia Auto</h3>
<p>
Ki·ªÅu Gia Auto l√† ƒë∆°n v·ªã chuy√™n cung c·∫•p ph·ª• t√πng √¥ t√¥ ch√≠nh h√£ng,
ph·ª•c v·ª• nhu c·∫ßu s·ª≠a ch·ªØa, b·∫£o d∆∞·ª°ng v√† thay th·∫ø th·ª±c t·∫ø
cho c·∫£ kh√°ch l·∫ª v√† c√°c gara tr√™n to√†n qu·ªëc.
</p>

<h3>V√¨ sao kh√°ch h√†ng tin ch·ªçn Ki·ªÅu Gia Auto?</h3>
<ul>
  <li>Ph·ª• t√πng ngu·ªìn g·ªëc r√µ r√†ng, ƒë√∫ng ch·ªßng lo·∫°i theo t·ª´ng d√≤ng xe</li>
  <li>Ch·∫•t l∆∞·ª£ng ·ªïn ƒë·ªãnh, ph√π h·ª£p l·∫Øp ƒë·∫∑t v√† s·ª≠ d·ª•ng th·ª±c t·∫ø</li>
  <li>H·ªó tr·ª£ t∆∞ v·∫•n k·ªπ thu·∫≠t r√µ r√†ng, d·ªÖ hi·ªÉu</li>
  <li>Giao h√†ng nhanh, ƒë√≥ng g√≥i c·∫©n th·∫≠n tr√™n to√†n qu·ªëc</li>
</ul>

<h4>Ch√≠nh s√°ch ƒë·ªïi tr·∫£ & h·ªó tr·ª£</h4>
<ul>
  <li>ƒê·ªïi tr·∫£ trong v√≤ng 7 ng√†y n·∫øu s·∫£n ph·∫©m c√≤n nguy√™n v·∫πn, ch∆∞a l·∫Øp r√°p</li>
  <li>√Åp d·ª•ng theo ch√≠nh s√°ch c·ªßa c·ª≠a h√†ng</li>
</ul>

<p>
üìç <strong>ƒê·ªãa ch·ªâ:</strong> Ng√µ 84 Kim Ng∆∞u, Qu·∫≠n Hai B√† Tr∆∞ng, H√† N·ªôi<br>
üìû <strong>Hotline:</strong> 0914.153.555 ‚Äì 0924.153.555 ‚Äì 0898.153.555 ‚Äì 0378.05.6666
</p>`;
  copyContent = content;

/* =========================
 * WEB PH·ª§ 1 ‚Äì theo M√É
 * ========================= */
} else if (website === 'phutungotokieugia') {
  content = `<h2>‚úîÔ∏è ${h1Text}</h2>
<p><strong>M√£ s·∫£n ph·∫©m:</strong> ${ma}</p>
<p><strong>Th∆∞∆°ng hi·ªáu:</strong> ${thuonghieu}</p>
<p><strong>Xu·∫•t x·ª©:</strong> ${xuatxu}</p>
${moTaTuDong}

<p>
<strong>${h1Text}</strong> l√† ph·ª• t√πng ƒë∆∞·ª£c l·ª±a ch·ªçn theo ƒë·ªùi xe s·ª≠ d·ª•ng,
gi√∫p ƒë·∫£m b·∫£o ƒë·ªô t∆∞∆°ng th√≠ch khi thay th·∫ø
v√† h·∫°n ch·∫ø sai l·ªách trong qu√° tr√¨nh l·∫Øp ƒë·∫∑t th·ª±c t·∫ø.
</p>

<h3>‚úîÔ∏è C·∫ßn mua ph·ª• t√πng ƒë√∫ng m√£?</h3>
<p>
Ki·ªÅu Gia Auto h·ªó tr·ª£ ki·ªÉm tra v√† ƒë·ªëi chi·∫øu m√£ s·∫£n ph·∫©m tr∆∞·ªõc khi giao h√†ng,
gi√∫p tr√°nh mua nh·∫ßm v√† ƒë·∫£m b·∫£o l·∫Øp ƒë·∫∑t ch√≠nh x√°c.
</p>

<ul>
  <li>T∆∞ v·∫•n ƒë√∫ng m√£, ƒë√∫ng ƒë·ªùi xe</li>
  <li>Ph·ª• t√πng ngu·ªìn g·ªëc r√µ r√†ng, ph√π h·ª£p thay th·∫ø th·ª±c t·∫ø</li>
  <li>H·ªó tr·ª£ giao h√†ng nhanh to√†n qu·ªëc</li>
</ul>

<h4>‚úîÔ∏è ƒê·ªïi tr·∫£ & b·∫£o h√†nh</h4>
<ul>
  <li>ƒê·ªïi tr·∫£ trong 7 ng√†y n·∫øu s·∫£n ph·∫©m c√≤n nguy√™n v·∫πn, ch∆∞a l·∫Øp r√°p</li>
</ul>
üìç <strong>Kho h√†ng:</strong> S·ªë 84 Ng√µ Kim Ng∆∞u, Hai B√† Tr∆∞ng, HN.<br>
<p>
üìû Hotline: <strong> 0924.153.555 ‚Äì 0914.153.555 ‚Äì 0898.153.555 ‚Äì 0378.05.6666</strong>
</p>`;
  copyContent = content;

/* =========================
 * WEB PH·ª§ 3 ‚Äì K·ª∏ THU·∫¨T / GARA
 * ========================= */
} else if (website === 'banphutung') {
  content = `<h2><strong>${h1Text}</strong></h2>
<p><strong>M√£ s·∫£n ph·∫©m:</strong> ${ma}</p>
<p><strong>Th∆∞∆°ng hi·ªáu:</strong> ${thuonghieu}</p>
<p><strong>Xu·∫•t x·ª©:</strong> ${xuatxu}</p>

${moTaTuDong}

<p>
<strong>${h1Text}</strong> ph√π h·ª£p cho nhu c·∫ßu thay th·∫ø nhanh,
t·ªëi ∆∞u chi ph√≠ v√† th·ªùi gian s·ª≠a ch·ªØa,
h·ªó tr·ª£ giao h√†ng to√†n qu·ªëc khi kh√°ch c·∫ßn nh·∫≠n s·ªõm.
</p>

<h3>‚úîÔ∏è Gi√° t·ªët ‚Äì h√†ng s·∫µn ‚Äì giao nhanh</h3>
<p>
Ki·ªÅu Gia Auto h·ªó tr·ª£ b√°o gi√° nhanh v√† t∆∞ v·∫•n l·ª±a ch·ªçn ph√π h·ª£p theo nhu c·∫ßu s·ª≠ d·ª•ng,
ph√π h·ª£p cho kh√°ch l·∫ª v√† gara c·∫ßn mua nhanh.
</p>

<ul>
  <li>Gi√° t·ªët, t·ªëi ∆∞u chi ph√≠ thay th·∫ø</li>
  <li>Ph·ª• t√πng ƒë√∫ng ch·ªßng lo·∫°i, d·ªÖ l·∫Øp ƒë·∫∑t</li>
  <li>Giao h√†ng nhanh, ƒë√≥ng g√≥i c·∫©n th·∫≠n to√†n qu·ªëc</li>
</ul>

<h4>‚úîÔ∏è ƒê·ªïi tr·∫£ & h·ªó tr·ª£</h4>
<ul>
  <li>ƒê·ªïi tr·∫£ trong 7 ng√†y n·∫øu s·∫£n ph·∫©m c√≤n nguy√™n v·∫πn, ch∆∞a l·∫Øp r√°p</li>
</ul>
üìç <strong>C·ª≠a h√†ng:</strong> 84 Kim Ng∆∞u, HBT, H√† N·ªôi.<br>
<p>
üìû <strong>B√°o gi√° nhanh:</strong> 0898.153.555 ‚Äì 0914.153.555 ‚Äì 0378.05.6666
</p>

<p><strong>S·∫£n ph·∫©m li√™n quan:</strong></p>`;
  copyContent = content;

/* =========================
 * WEB PH·ª§ 2 ‚Äì GI√Å R·∫∫ / B√ÅN NHANH
 * ========================= */
} else if (website === 'phutunggiare') {
  content = `<h2><strong>${h1Text}</strong></h2>
<p><strong>M√£ s·∫£n ph·∫©m:</strong> ${ma}</p>
<p><strong>Th∆∞∆°ng hi·ªáu:</strong> ${thuonghieu}</p>
<p><strong>Xu·∫•t x·ª©:</strong> ${xuatxu}</p>

${moTaTuDong}

<p>
<strong>${h1Text}</strong> l√† ph·ª• t√πng ƒë∆∞·ª£c l·ª±a ch·ªçn theo m√£ s·∫£n ph·∫©m,
gi√∫p ƒë·∫£m b·∫£o ƒë·ªô t∆∞∆°ng th√≠ch ch√≠nh x√°c khi thay th·∫ø
v√† h·∫°n ch·∫ø r·ªßi ro l·∫Øp nh·∫ßm trong qu√° tr√¨nh s·ª≠a ch·ªØa th·ª±c t·∫ø.
</p>

<h3>‚úîÔ∏è C·∫ßn mua ph·ª• t√πng theo ƒë√∫ng m√£?</h3>
<p>
Ki·ªÅu Gia Auto h·ªó tr·ª£ ki·ªÉm tra v√† ƒë·ªëi chi·∫øu m√£ s·∫£n ph·∫©m tr∆∞·ªõc khi giao h√†ng,
gi√∫p kh√°ch h√†ng y√™n t√¢m khi thay th·∫ø v√† l·∫Øp ƒë·∫∑t.
</p>

<ul>
  <li>ƒê·ªëi chi·∫øu m√£ k·ªπ tr∆∞·ªõc khi xu·∫•t kho</li>
  <li>Ph·ª• t√πng ƒë√∫ng ch·ªßng lo·∫°i, ph√π h·ª£p ƒë·ªùi xe</li>
  <li>H·ªó tr·ª£ giao h√†ng nhanh tr√™n to√†n qu·ªëc</li>
</ul>

<h4>‚úîÔ∏è ƒê·ªïi tr·∫£ & h·ªó tr·ª£</h4>
<ul>
  <li>ƒê·ªïi tr·∫£ trong 7 ng√†y n·∫øu s·∫£n ph·∫©m c√≤n nguy√™n v·∫πn, ch∆∞a l·∫Øp r√°p</li>
</ul>
üìç <strong>Ph√¢n ph·ªëi b·ªüi:</strong> Ki·ªÅu Gia Auto - Ng√µ 84 Kim Ng∆∞u, H√† N·ªôi.<br>
<p>
üìû <strong>H·ªó tr·ª£ ki·ªÉm tra m√£:</strong> 0378.05.6666 ‚Äì 0914.153.555 ‚Äì 0924.153.555 ‚Äì 0898.153.555
</p>`;
        copyContent = content;
      } else if (website === 'shopee') {
        content = `<h2><strong>${ten}</strong></h2>
<p><strong>M√£ s·∫£n ph·∫©m:</strong> ${ma}</p>
<p><strong>Th∆∞∆°ng hi·ªáu:</strong> ${thuonghieu}</p>
<p><strong>Xu·∫•t x·ª©:</strong> ${xuatxu}</p>
${moTaTuDong}
${danhSachXe}
<h3>‚úîÔ∏è Ki·ªÅu Gia Auto - Ph·ª• t√πng √¥ t√¥ ch√≠nh h√£ng, gi√° t·ªët nh·∫•t</h3>
<ul>
  <li>Cung c·∫•p ‚Äú${ten}‚Äù ch·∫•t l∆∞·ª£ng v∆∞·ª£t tr·ªôi, gi√° c·∫£ c·∫°nh tranh.</li>
  <li>Khuy√™n d√πng ph·ª• t√πng c√≥ ngu·ªìn g·ªëc r√µ r√†ng ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªáu su·∫•t v√† ƒë·ªô b·ªÅn.</li>
  <li>Nh·∫≠p kh·∫©u v√† ph√¢n ph·ªëi ph·ª• t√πng ch√≠nh h√£ng t·ªõi nhi·ªÅu gara tr√™n to√†n qu·ªëc.</li>
  <li>ƒê·ªôi ng≈© nh√¢n vi√™n am hi·ªÉu k·ªπ thu·∫≠t, t∆∞ v·∫•n t·∫≠n t√¢m, chuy√™n nghi·ªáp.</li>
</ul>
<h3>‚úîÔ∏è Ch√≠nh s√°ch b·∫£o h√†nh:</h3>
<ul>
  <li>B·∫£o h√†nh 1 ƒë·ªïi 1 trong 7 ng√†y n·∫øu ph√°t hi·ªán l·ªói t·ª´ nh√† s·∫£n xu·∫•t.</li>
  <li>S·∫£n ph·∫©m ƒë∆∞·ª£c ƒë·ªïi tr·∫£ trong v√≤ng 7 ng√†y, v·ªõi ƒëi·ªÅu ki·ªán c√≤n nguy√™n v·∫πn, ch∆∞a l·∫Øp r√°p, kh√¥ng tr·∫ßy x∆∞·ªõc, c√≤n nguy√™n bao b√¨.</li>
</ul>
<h3>‚úîÔ∏è L∆∞u √Ω:</h3>
<ul>
  <li>Khi m·ªü s·∫£n ph·∫©m, vui l√≤ng quay video ƒë·ªÉ ƒë·∫£m b·∫£o quy·ªÅn l·ª£i ƒë·ªïi tr·∫£ n·∫øu c√≥ l·ªói t·ª´ nh√† cung c·∫•p.</li>
  <li>Qu√Ω kh√°ch vui l√≤ng ƒë√°nh gi√° s·∫£n ph·∫©m ƒë·ªÉ nh·∫≠n th√™m ∆∞u ƒë√£i t·ª´ shop!</li>
</ul>
<h3>‚úîÔ∏è Cam k·∫øt c·ªßa Ki·ªÅu Gia Auto:</h3>
<ul>
  <li>ƒê·ªôi ng≈© t∆∞ v·∫•n chuy√™n nghi·ªáp, mang ƒë·∫øn tr·∫£i nghi·ªám tuy·ªát v·ªùi cho kh√°ch h√†ng.</li>
  <li>Ho√†n ti·ªÅn ho·∫∑c ƒë·ªïi s·∫£n ph·∫©m m·ªõi n·∫øu qu√Ω kh√°ch kh√¥ng h√†i l√≤ng v√¨ l·ªói s·∫£n ph·∫©m.</li>
  <li>Th∆∞∆°ng hi·ªáu uy t√≠n, ƒë√°ng tin c·∫≠y.</li>
</ul>
<h3>‚úîÔ∏è ƒê·∫£m b·∫£o t·ª´ Ki·ªÅu Gia Auto:</h3>
<ul>
  <li>H√¨nh ·∫£nh ‚Äú${ten}‚Äù ƒë√∫ng 100% v·ªõi th·ª±c t·∫ø.</li>
  <li>Ch·∫•t l∆∞·ª£ng s·∫£n ph·∫©m ƒë·∫£m b·∫£o tuy·ªát ƒë·ªëi.</li>
  <li>H·ªó tr·ª£ ƒë·ªïi tr·∫£ theo ch√≠nh s√°ch quy ƒë·ªãnh.</li>
  <li>Giao h√†ng nhanh ch√≥ng tr√™n to√†n qu·ªëc.</li>
</ul>
<p>Ch√¢n th√†nh c·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng v√† ƒë·ªìng h√†nh c√πng Ki·ªÅu Gia Auto!</p>`;
        
        // Chuy·ªÉn n·ªôi dung HTML sang plain text, nh∆∞ng gi·ªØ ƒë·ªãnh d·∫°ng in ƒë·∫≠m
        let plainMoTaTuDong = moTaTuDong
          .replace(/<strong>(.*?)<\/strong>/g, '**$1**') // Chuy·ªÉn <strong> th√†nh **text**
          .replace(/<[^>]+>/g, ''); // Lo·∫°i b·ªè c√°c th·∫ª HTML kh√°c
        let plainDanhSachXe = danhSachXe
          .replace(/<strong>(.*?)<\/strong>/g, '**$1**')
          .replace(/<[^>]+>/g, '');

        copyContent = `**${ten}**\nM√£ s·∫£n ph·∫©m: ${ma}\nTh∆∞∆°ng hi·ªáu: ${thuonghieu}\nXu·∫•t x·ª©: ${xuatxu}\n\n${plainMoTaTuDong}\n\n${plainDanhSachXe}\n\n**Ki·ªÅu Gia Auto - Ph·ª• t√πng √¥ t√¥ ch√≠nh h√£ng, gi√° t·ªët nh·∫•t**\n- Cung c·∫•p ‚Äú${ten}‚Äù ch·∫•t l∆∞·ª£ng v∆∞·ª£t tr·ªôi, gi√° c·∫£ c·∫°nh tranh.\n- Khuy√™n d√πng ph·ª• t√πng c√≥ ngu·ªìn g·ªëc r√µ r√†ng ƒë·ªÉ ƒë·∫£m b·∫£o hi·ªáu su·∫•t v√† ƒë·ªô b·ªÅn.\n- Nh·∫≠p kh·∫©u v√† ph√¢n ph·ªëi ph·ª• t√πng ch√≠nh h√£ng t·ªõi nhi·ªÅu gara tr√™n to√†n qu·ªëc.\n- ƒê·ªôi ng≈© nh√¢n vi√™n am hi·ªÉu k·ªπ thu·∫≠t, t∆∞ v·∫•n t·∫≠n t√¢m, chuy√™n nghi·ªáp.\n\n**Ch√≠nh s√°ch b·∫£o h√†nh:**\n- B·∫£o h√†nh 1 ƒë·ªïi 1 trong 7 ng√†y n·∫øu ph√°t hi·ªán l·ªói t·ª´ nh√† s·∫£n xu·∫•t.\n- S·∫£n ph·∫©m ƒë∆∞·ª£c ƒë·ªïi tr·∫£ trong v√≤ng 7 ng√†y, v·ªõi ƒëi·ªÅu ki·ªán c√≤n nguy√™n v·∫πn, ch∆∞a l·∫Øp r√°p, kh√¥ng tr·∫ßy x∆∞·ªõc, c√≤n nguy√™n bao b√¨.\n\n**L∆∞u √Ω:**\n- Khi m·ªü s·∫£n ph·∫©m, vui l√≤ng quay video ƒë·ªÉ ƒë·∫£m b·∫£o quy·ªÅn l·ª£i ƒë·ªïi tr·∫£ n·∫øu c√≥ l·ªói t·ª´ nh√† cung c·∫•p.\n- Qu√Ω kh√°ch vui l√≤ng ƒë√°nh gi√° s·∫£n ph·∫©m ƒë·ªÉ nh·∫≠n th√™m ∆∞u ƒë√£i t·ª´ shop!\n\n**Cam k·∫øt c·ªßa Ki·ªÅu Gia Auto:**\n- ƒê·ªôi ng≈© t∆∞ v·∫•n chuy√™n nghi·ªáp, mang ƒë·∫øn tr·∫£i nghi·ªám tuy·ªát v·ªùi cho kh√°ch h√†ng.\n- Ho√†n ti·ªÅn ho·∫∑c ƒë·ªïi s·∫£n ph·∫©m m·ªõi n·∫øu qu√Ω kh√°ch kh√¥ng h√†i l√≤ng v√¨ l·ªói s·∫£n ph·∫©m.\n- Th∆∞∆°ng hi·ªáu uy t√≠n, ƒë√°ng tin c·∫≠y.\n\n**ƒê·∫£m b·∫£o t·ª´ Ki·ªÅu Gia Auto:**\n- H√¨nh ·∫£nh ‚Äú${ten}‚Äù ƒë√∫ng 100% v·ªõi th·ª±c t·∫ø.\n- Ch·∫•t l∆∞·ª£ng s·∫£n ph·∫©m ƒë·∫£m b·∫£o tuy·ªát ƒë·ªëi.\n- H·ªó tr·ª£ ƒë·ªïi tr·∫£ theo ch√≠nh s√°ch quy ƒë·ªãnh.\n- Giao h√†ng nhanh ch√≥ng tr√™n to√†n qu·ªëc.\n\nCh√¢n th√†nh c·∫£m ∆°n qu√Ω kh√°ch ƒë√£ tin t∆∞·ªüng v√† ƒë·ªìng h√†nh c√πng Ki·ªÅu Gia Auto!`;
      }

      content = content.replace(/<li>(.*?)\.\s*<\/li>/g, '<li>$1</li>');
      document.getElementById('preview').innerHTML = content;

      const copyButton = document.getElementById('copyButton');
copyButton.dataset.content = copyContent;

// ‚úÖ Ghim info ƒë·ªÉ check/commit ƒë√∫ng "moTaTuDong"
copyButton.dataset.productKey = kgMakeProductKey(ten, ma);
copyButton.dataset.website    = website;
copyButton.dataset.descHtml   = moTaTuDong || '';

// ‚úÖ Guard quy·∫øt ƒë·ªãnh hi·ªán/·∫©n n√∫t copy (·∫©n n·∫øu tr√πng v·ªõi web kh√°c ƒë√£ copy)
await kgGuardCopy(copyButton, { silent: true });
}


// =========================
// H√†m sao ch√©p n·ªôi dung
// =========================
async function saoChepNoiDung() {
  const copyButton = document.getElementById('copyButton');

  // ‚úÖ ch·∫∑n copy n·∫øu tr√πng
  const g = await kgGuardCopy(copyButton, { silent: false });
  if (g.guarded) return;

  const website = copyButton.dataset.website || document.getElementById('website').value;
  let content = copyButton.dataset.content;

  if (!content) {
    alert('Ch∆∞a c√≥ n·ªôi dung ƒë·ªÉ sao ch√©p! Vui l√≤ng t·∫°o n·ªôi dung tr∆∞·ªõc.');
    return;
  }

  // ===== L√†m s·∫°ch n·ªôi dung =====
  if (website === 'banphutung' || website === 'phutungotokieugia') {
    const parser = new DOMParser();
    const doc = parser.parseFromString(content, 'text/html');

    const removeEmptyNodes = (node) => {
      if (node.nodeType === Node.ELEMENT_NODE) {
        if (['P', 'DIV', 'UL', 'LI'].includes(node.tagName)
          && !node.textContent.trim()
          && !node.querySelector('a, strong, em')) {
          node.remove();
          return;
        }
        Array.from(node.childNodes).forEach(removeEmptyNodes);
      }
    };
    removeEmptyNodes(doc.body);

    content = doc.body.innerHTML.trim()
      .replace(/\n\s*\n/g, '\n')
      .replace(/\s+$/gm, '');

  } else if (website === 'shopee') {
    content = content.trim()
      .replace(/\n\s*\n/g, '\n')
      .replace(/\s+$/gm, '');

  } else {
    const parser = new DOMParser();
    const doc = parser.parseFromString(content, 'text/html');

    const removeEmptyNodes = (node) => {
      if (node.nodeType === Node.ELEMENT_NODE) {
        if (['P', 'DIV', 'UL', 'LI'].includes(node.tagName)
          && !node.textContent.trim()
          && !node.querySelector('a, strong, em')) {
          node.remove();
          return;
        }
        Array.from(node.childNodes).forEach(removeEmptyNodes);
      }
    };
    removeEmptyNodes(doc.body);

    content = doc.body.innerHTML.trim()
      .replace(/\n\s*\n/g, '\n')
      .replace(/\s+$/gm, '');
  }

  // ===== Commit + UI sau copy =====
  const commitAfterCopy = async () => {
  if (KG_TRACK_SITES.has(website)) {
    const pkey = copyButton.dataset.productKey;
    const desc = copyButton.dataset.descHtml;

    if (pkey && desc) {
      kgCommitDesc(pkey, website, desc); // localStorage
      await kgInsertDescToSupabase(pkey, website, desc); // üî• Supabase
    }
  }

  alert('ƒê√£ sao ch√©p n·ªôi dung th√†nh c√¥ng!');
  copyButton.style.display = 'none';
};

  // ===== Copy =====
  if (navigator.clipboard && window.isSecureContext) {
    navigator.clipboard.writeText(content)
      .then(commitAfterCopy)
      .catch(err => {
        console.error('L·ªói sao ch√©p clipboard:', err);
        const ok = fallbackCopy(content);
        if (ok) commitAfterCopy();
      });
  } else {
    const ok = fallbackCopy(content);
    if (ok) commitAfterCopy();
  }
}

// =========================
// Ph∆∞∆°ng √°n d·ª± ph√≤ng ƒë·ªÉ sao ch√©p
// =========================
function fallbackCopy(text) {
  const textArea = document.createElement('textarea');
  textArea.value = text;
  textArea.style.position = 'fixed';
  textArea.style.opacity = '0';
  document.body.appendChild(textArea);
  textArea.focus();
  textArea.select();

  try {
    const ok = document.execCommand('copy');
    if (!ok) alert('Kh√¥ng th·ªÉ sao ch√©p n·ªôi dung! Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c sao ch√©p th·ªß c√¥ng.');
    return ok;
  } catch (err) {
    console.error('L·ªói sao ch√©p d·ª± ph√≤ng:', err);
    alert('Kh√¥ng th·ªÉ sao ch√©p n·ªôi dung! Vui l√≤ng th·ª≠ l·∫°i ho·∫∑c sao ch√©p th·ªß c√¥ng.');
    return false;
  } finally {
    document.body.removeChild(textArea);
  }
}
(() => {
  const raw = kgLoadDescStore();
  const norm = kgNormalizeStore(raw);
  if (norm.changed) kgSaveDescStore(norm.store);
})();
</script>
</body>
</html>
